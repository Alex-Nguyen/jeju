<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Fly to a location</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.3.1/mapbox-gl.js'></script>
    <script src='https://unpkg.com/three@0.106.2/build/three.min.js'></script>
    <script src="https://unpkg.com/three@0.106.2/examples/js/loaders/GLTFLoader.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.3.1/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="assets/css/main.min.css"/>
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>

<style>
    .map-overlay-container {
        position: absolute;
        width: 25%;
        top: 0;
        left: 0;
        padding: 10px;
        z-index: 1;
    }

    .map-overlay {
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        background-color: #fff;
        border-radius: 3px;
        padding: 10px;
        box-shadow:0 1px 2px rgba(0,0,0,0.20);
    }

    .map-overlay h2,
    .map-overlay p {
        margin: 0 0 10px;
    }
    #flyto {
        display: block;
        position: relative;
        margin: 0px auto;
        width: 50%;
        height: 40px;
        padding: 10px;
        border: none;
        border-radius: 3px;
        font-size: 12px;
        text-align: center;
        color: #fff;
        background: #ee8a65;
        z-index: 10;
    }
</style>

<br/>
<button id='flyto'>Fly</button>
<div id="trailMenu" class="trailmenu view" style="z-index: 10">
    <li><a id="btn1" class="btn-1"><span class="left">Hanra Mountain</span></a></li>
    <li><a id="btn2"  class="btn-2"><span class="left">Dolharubang</span></a></li>
    <li><a id="btn3" class="btn-3"><span class="right">Kwandukjung</span></a></li>
    <li><a id="btn4" class="btn-4"><span class="left">Jeju Folk Valley</span></a></li>
    <li><a id="btn5" class="btn-5"><span class="right">The Island</span></a></li>
</div>
<div id='map'></div>
<div class='map-overlay-container'>
    <div class='map-overlay'>
        <h2 id='location-title'></h2>
        <p id='location-description'></p>
        <small>Text credit: <a target='_blank' href='http://www.nycgo.com/neighborhoods'>nycgo.com</a></small>
    </div>
</div>
<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoidmluaG50IiwiYSI6ImNqb2VqdXZvaDE4cnkzcG80dXkxZzlhNWcifQ.G6sZ1ukp_DhiSmCvgKblVQ';
    var locations = [{
        "id": "2",
        "title": "The Bronx",
        "description": "This is where hip-hop was born, where the Yankees became a dynasty and where you can find New York City's leading zoo and botanical garden.",
        "camera": {
            center: [126.396038, 33.406394],
            zoom: 16,
            pitch: 50
        }
    }, {
        "id": "3",
        "title": "Songak Mountain",
        "description": "Mt. Songak is a simple volcano on Jeju Island which has double craters and a parasitic volcano. Crater 1 is about 500 m in diameter, 1.7 km in circumference. Crater 2, the mouth of the volcano in Crater 1, is about 400 m in diameter, 69 m in depth and leans vertically.",
        "camera": {
            center: [126.310454, 33.231492],
            bearing: -8.9,
            zoom: 16
        }
    }, {
        "id": "1",
        "title": "Manjanggul Cave",
        "description": "Even if you think you know Manhattan—its world-class museums, fine dining and unforgettable views—the borough always has something new and exciting in store.",
        "camera": {
            center: [126.771460, 33.528892],
            bearing: 25.3,
            zoom: 16
        }
    }];


    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [126.53, 33.37],
        zoom: 2,
        antialias:true
    });
    map.on('load', function() {
// Insert the layer beneath any symbol layer.
        var layers = map.getStyle().layers;

        var labelLayerId;
        for (var i = 0; i < layers.length; i++) {
            if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
                labelLayerId = layers[i].id;
                break;
            }
        }

        map.addLayer({
            'id': '3d-buildings',
            'source': 'composite',
            'source-layer': 'building',
            'filter': ['==', 'extrude', 'true'],
            'type': 'fill-extrusion',
            'minzoom': 15,
            'paint': {
                'fill-extrusion-color': '#aaa',
                'fill-extrusion-height': [
                    "interpolate", ["linear"], ["zoom"],
                    15, 0,
                    15.05, ["get", "height"]
                ],
                'fill-extrusion-base': [
                    "interpolate", ["linear"], ["zoom"],
                    15, 0,
                    15.05, ["get", "min_height"]
                ],
                'fill-extrusion-opacity': .6
            }
        }, labelLayerId);
    });
    var modelOrigin = [126.310454, 33.231492];
    var modelAltitude = 0;
    var modelRotate = [Math.PI / 2, 0, 0];

    var modelAsMercatorCoordinate = mapboxgl.MercatorCoordinate.fromLngLat(modelOrigin, modelAltitude);

    // transformation parameters to position, rotate and scale the 3D model onto the map
    var modelTransform = {
        translateX: modelAsMercatorCoordinate.x,
        translateY: modelAsMercatorCoordinate.y,
        translateZ: modelAsMercatorCoordinate.z,
        rotateX: modelRotate[0],
        rotateY: modelRotate[1],
        rotateZ: modelRotate[2],
        /* Since our 3D model is in real world meters, a scale transform needs to be
        * applied since the CustomLayerInterface expects units in MercatorCoordinates.
        */
        scale: modelAsMercatorCoordinate.meterInMercatorCoordinateUnits()
    };

    var THREE = window.THREE;

    // configuration of the custom layer for a 3D model per the CustomLayerInterface
    var customLayer = {
        id: '3d-model',
        type: 'custom',
        renderingMode: '3d',
        onAdd: function(map, gl) {
            this.camera = new THREE.Camera();
            this.scene = new THREE.Scene();

// create two three.js lights to illuminate the model
            var directionalLight = new THREE.DirectionalLight(0xffffff);
            directionalLight.position.set(0, -70, 100).normalize();
            this.scene.add(directionalLight);

            var directionalLight2 = new THREE.DirectionalLight(0xffffff);
            directionalLight2.position.set(0, 70, 100).normalize();
            this.scene.add(directionalLight2);

// use the three.js GLTF loader to add the 3D model to the three.js scene
            var loader = new THREE.GLTFLoader();
            loader.load('assets/model/temple.glb', (function (gltf) {
                this.scene.add(gltf.scene);
            }).bind(this));
            this.map = map;

// use the Mapbox GL JS map canvas for three.js
            this.renderer = new THREE.WebGLRenderer({
                canvas: map.getCanvas(),
                context: gl,
                antialias: true
            });

            this.renderer.autoClear = false;
        },
        render: function(gl, matrix) {
            var rotationX = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(1, 0, 0), modelTransform.rotateX);
            var rotationY = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(0, 1, 0), modelTransform.rotateY);
            var rotationZ = new THREE.Matrix4().makeRotationAxis(new THREE.Vector3(0, 0, 1), modelTransform.rotateZ);

            var m = new THREE.Matrix4().fromArray(matrix);
            var l = new THREE.Matrix4().makeTranslation(modelTransform.translateX, modelTransform.translateY, modelTransform.translateZ)
                .scale(new THREE.Vector3(modelTransform.scale, -modelTransform.scale, modelTransform.scale))
                .multiply(rotationX)
                .multiply(rotationY)
                .multiply(rotationZ);

            this.camera.projectionMatrix.elements = matrix;
            this.camera.projectionMatrix = m.multiply(l);
            this.renderer.state.reset();
            this.renderer.render(this.scene, this.camera);
            this.map.triggerRepaint();
        }
    };

    map.on('style.load', function() {
        map.addLayer(customLayer, 'waterway-label');
    });
    document.getElementById('flyto').addEventListener('click', function () {
        map.flyTo({
            center: [
                126.53, 33.37],
            zoom:10.3,
            speed: 0.5
        });

        map.once('moveend', function() {
            //playback(0);
        });

    });

    map.on('click', 'waterway-label', function (e) {
        alert("You click on 3d-model")
    });
    let btn1 = document.getElementById('btn1');
    btn1.addEventListener('click',function () {
        map.flyTo(locations[0].camera);
    })

    let btn2 = document.getElementById('btn2');
    btn2.addEventListener('click',function () {
        map.flyTo(locations[1].camera);
    })

    let btn3 = document.getElementById('btn3');
    btn3.addEventListener('click',function () {
        map.flyTo(locations[2].camera);
    })
</script>

</body>
</html>